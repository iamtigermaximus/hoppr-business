// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model AdminUser {
  id             String    @id @default(cuid())
  email          String    @unique
  name           String
  role           AdminRole @default(SUPER_ADMIN)
  hashedPassword String?
  isActive       Boolean   @default(true)
  lastLogin      DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  auditLogs   AuditLog[]
  createdBars Bar[]      @relation("BarCreatedBy")
  barImports  BarImport[] 

  @@map("admin_users")
}

model Bar {
  id          String  @id @default(cuid())
  name        String  @unique
  description String?
  address     String
  city        String
  district    String?
  type        BarType
  latitude    Float?
  longitude   Float?

  // Contact Information
  phone     String?
  email     String?
  website   String?
  instagram String?

  // Business Information
  operatingHours Json?
  priceRange     PriceRange?
  capacity       Int?
  amenities      String[]

  // Media
  coverImage String?
  imageUrls  String[]
  logoUrl    String?

  // Status & Verification
  status     BarStatus @default(UNCLAIMED)
  isVerified Boolean   @default(false)
  isActive   Boolean   @default(true)

  // VIP Features
  vipEnabled Boolean @default(false)

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  claimedAt DateTime?

  // Relations - FIXED: Added missing relations
  staff        BarStaff[]
  promotions   BarPromotion[]
  vipPasses    VIPPass[]
  auditLogs    AuditLog[]
  vipPassScans VIPPassScan[] // ← ADDED THIS
  createdBy    AdminUser?     @relation("BarCreatedBy", fields: [createdById], references: [id])
  createdById  String?

  @@map("bars")
}

model BarStaff {
  id             String       @id @default(cuid())
  barId          String
  email          String
  name           String
  role           BarStaffRole @default(STAFF)
  permissions    String[]
  hashedPassword String?
  isActive       Boolean      @default(true)
  lastLogin      DateTime?

  // Timestamps 
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations - FIXED: Added missing relations
  bar   Bar           @relation(fields: [barId], references: [id], onDelete: Cascade)
  scans VIPPassScan[] // ← ADDED THIS

  @@unique([barId, email])
  @@map("bar_staff")
}

model BarPromotion {
  id           String        @id @default(cuid())
  barId        String
  title        String
  description  String
  type         PromotionType
  imageUrl     String?
  accentColor  String?
  callToAction String?
  discount     Float?
  conditions   String[]
  startDate    DateTime
  endDate      DateTime
  validDays    String[]
  validHours   Json?
  isActive     Boolean       @default(true)
  isApproved   Boolean       @default(false)
  priority     Int           @default(1)
  views        Int           @default(0)
  clicks       Int           @default(0)
  redemptions  Int           @default(0)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  bar Bar @relation(fields: [barId], references: [id], onDelete: Cascade)

  @@map("bar_promotions")
}

model VIPPass {
  id            String      @id @default(cuid())
  barId         String
  name          String
  description   String?
  type          VIPPassType @default(SKIP_LINE)
  price         Float
  originalPrice Float?
  benefits      String[]
  validityStart DateTime
  validityEnd   DateTime
  validDays     String[]
  totalQuantity Int
  soldCount     Int         @default(0)
  maxPerUser    Int         @default(2)
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations - FIXED: Added missing relations
  bar   Bar           @relation(fields: [barId], references: [id], onDelete: Cascade)
  scans VIPPassScan[] // ← ADDED THIS

  @@map("vip_passes")
}

model VIPPassScan {
  id           String   @id @default(cuid())
  vipPassId    String
  barId        String
  scannedById  String
  qrCode       String
  customerName String?
  scannedAt    DateTime @default(now())

  // Relations - FIXED: All relations now complete
  vipPass   VIPPass  @relation(fields: [vipPassId], references: [id])
  bar       Bar      @relation(fields: [barId], references: [id])
  scannedBy BarStaff @relation(fields: [scannedById], references: [id])

  @@map("vip_pass_scans")
}

model AuditLog {
  id        String   @id @default(cuid())
  adminId   String?
  barId     String?
  action    String
  resource  String
  details   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  admin AdminUser? @relation(fields: [adminId], references: [id])
  bar   Bar?       @relation(fields: [barId], references: [id])

  @@map("audit_logs")
}

// ENUMS (keep the same)
enum AdminRole {
  SUPER_ADMIN
  CONTENT_MODERATOR
  ANALYTICS_VIEWER
  SUPPORT
}

enum BarStaffRole {
  OWNER
  MANAGER
  PROMOTIONS_MANAGER
  STAFF
  VIEWER
}

enum BarType {
  PUB
  CLUB
  LOUNGE
  COCKTAIL_BAR
  RESTAURANT_BAR
  SPORTS_BAR
  KARAOKE
  LIVE_MUSIC
}

enum BarStatus {
  UNCLAIMED
  CLAIMED
  VERIFIED
  SUSPENDED
}

enum PriceRange {
  BUDGET
  MODERATE
  PREMIUM
  LUXURY
}

enum PromotionType {
  HAPPY_HOUR
  STUDENT_DISCOUNT
  LADIES_NIGHT
  THEME_NIGHT
  FOOD_SPECIAL
  DRINK_SPECIAL
  COVER_DISCOUNT
  VIP_OFFER
}

enum VIPPassType {
  SKIP_LINE
  COVER_INCLUDED
  PREMIUM_ENTRY
  DRINK_PACKAGE
}

model BarImport {
  id          String   @id @default(cuid())
  fileName    String
  fileSize    Int
  totalRows   Int
  importedRows Int
  failedRows  Int
  status      ImportStatus @default(PENDING)
  errors      Json?
  importedBy  String // admin user ID or email
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  importedByUser AdminUser? @relation(fields: [importedBy], references: [id])


  @@map("bar_imports")
}

enum ImportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  PARTIAL
}